graph TD
    A["UE in 5GMM-CONNECTED mode"] --> B{"UE initiates data transfer"}
    B --> C["Send UL NAS TRANSPORT message to AMF"]
    C --> D["AMF receives UL NAS TRANSPORT message"]
    D --> E["Check Payload container type IE"]
    E -- "N1 SM information" --> F["Look up PDU session routing context"]
    E -- "SMS" --> G["Send content to SMSF"]
    E -- "LPP" --> H["Send content to LMF"]
    E -- "SLPP" --> I["Send content to LMF"]
    E -- "SOR" --> J["Send content to UDM"]
    E -- "UE policy container" --> K["Send content to PCF"]
    E -- "UE parameters update container" --> L["Send content to UDM"]
    E -- "Location services message container" --> M["Send content to upper layer location services application"]
    E -- "CIoT user data container" --> N["Look up PDU session routing context"]
    E -- "Service-level-AA container" --> O["Send content to UAS-NF"]
    E -- "UPP-CMI container" --> P["Send content to upper layer location services application"]
    E -- "Multiple payloads" --> Q["Decode content of Payload container IE"]
    Q --> R["Handle each payload container entry"]
    F -- "Context found" --> S["Send 5GSM message to SMF"]
    F -- "Context not found" --> T["Select SMF"]
    T --> U["Store PDU session routing context"]
    U --> S
    N -- "Context found" --> V["Send content to SMF"]
    N -- "Context not found" --> W["Send back CIoT user data container"]
    D --> X["Congestion Check?"]
    X -- "Yes" --> Y["Send DL NAS TRANSPORT with 5GMM cause and back-off timer"]
    X -- "No" --> Z["Proceed with routing"]
    D --> AA["Access barring?"]
    AA -- "Yes" --> AB["UE stays in the current serving cell"]
    AA -- "No" --> BB["Proceed with transport"]